<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zypher â€” Cosmic Portal</title>

<!-- ============================
     STYLES
     ============================ -->
<style>
  :root{
    --bg-1:#080610;
    --bg-2:#120925;
    --accent-1:#9fb3ff;
    --accent-2:#6a4bff;
    --panel-bg: rgba(16,16,36,0.52);
    --panel-border: rgba(150,150,255,0.15);
    --glass-blur: 14px;
  }

  html,body{
    height:100%;
    margin:0;
    padding:0;
    background: radial-gradient(circle at 20% 20%, var(--bg-2) 0%, var(--bg-1) 60%);
    color: #ecf2ff;
    font-family: "Segoe UI", Roboto, Helvetica, monospace;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Full canvas layers */
  canvas.layer {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
    z-index:-10;
    display:block;
  }

  .fog-layer {
    position:fixed; top:0; left:0; width:100%; height:100%; z-index:-9;
    pointer-events:none;
    background:
      radial-gradient(circle at 15% 20%, rgba(110,80,255,0.10), transparent 12%),
      radial-gradient(circle at 80% 70%, rgba(90,140,255,0.06), transparent 20%);
    transform-origin:center;
    will-change:transform;
    filter: blur(14px);
    mix-blend-mode: screen;
  }

  /* Planets container (absolute positioned planets) */
  .planet-wrap { position: fixed; inset:0; pointer-events:none; z-index:-7; }

  .planet{
    position:absolute;
    border-radius:50%;
    box-shadow: 0 10px 30px rgba(80,80,140,0.25), inset 0 -6px 18px rgba(0,0,0,0.35);
    transform-origin:center center;
    will-change: transform;
    display:block;
  }

  .planet .ring{
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%) rotateX(65deg);
    border-radius:50%;
    pointer-events:none;
    mix-blend-mode:screen;
    will-change:transform;
  }

  /* UI container centered */
  .ui {
    position:relative;
    z-index: 20;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    margin: 32px auto;
    width: 100%;
    max-width: 1100px;
    box-sizing:border-box;
    pointer-events: auto; /* allow clicking */
  }

  /* tabs */
  .tabs {
    display:flex;
    gap:14px;
    margin: 6px 0 18px 0;
  }
  .tab {
    padding:10px 18px;
    border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid var(--panel-border);
    color:var(--accent-1);
    cursor:pointer;
    user-select:none;
    transition: all .22s ease;
    font-weight:600;
  }
  .tab.active {
    box-shadow: 0 6px 24px rgba(80,80,160,0.18);
    background: linear-gradient(180deg, rgba(140,130,255,0.06), rgba(90,70,230,0.02));
    color: #06102a;
    transform: translateY(-2px) scale(1.02);
  }

  /* section panels (centered) */
  .section {
    width: 92%;
    max-width:900px;
    margin: 8px auto 28px auto;
    display:none;
  }
  .section.active { display:block; }

  .panel {
    background: var(--panel-bg);
    border-radius: 20px;
    padding:18px;
    border:1px solid var(--panel-border);
    backdrop-filter: blur(var(--glass-blur));
    box-shadow: 0 10px 30px rgba(10,10,24,0.36);
    transition: transform .24s ease, box-shadow .24s ease;
  }

  .panel .title {
    font-size:20px; margin:0 0 8px 0; color:var(--accent-1);
  }

  /* hero */
  .hero {
    text-align:center;
    padding:28px 16px;
    border-radius:22px;
  }
  .hero h1 {
    margin:0;
    font-size:48px;
    letter-spacing:1px;
    color:var(--accent-1);
    text-shadow: 0 6px 30px rgba(120,110,255,0.25);
  }
  .hero .sub { margin-top:6px; color: #cfe0ff; opacity:.9; }

  /* search */
  .search-row { margin-top:18px; display:flex; justify-content:center; gap:10px; align-items:center; }
  .search-row input{
    width:60%;
    min-width:220px;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid rgba(180,180,255,0.12);
    background: rgba(0,0,0,0.35);
    color: white;
    outline:none;
    font-size:16px;
  }
  .search-row button {
    padding:12px 16px;
    border-radius:12px;
    border:none;
    background: linear-gradient(90deg,var(--accent-2),var(--accent-1));
    color:#041029;
    font-weight:700;
    cursor:pointer;
  }

  /* quick links */
  .quick-links { display:flex; gap:12px; justify-content:center; margin-top:18px; flex-wrap:wrap; }
  .quick-card {
    border-radius:14px; padding:12px 18px; min-width:120px;
    background: rgba(255,255,255,0.02);
    border:1px solid rgba(180,180,255,0.04);
    cursor:pointer; transition: transform .16s ease;
  }
  .quick-card:hover { transform:translateY(-6px) scale(1.03); box-shadow: 0 10px 30px rgba(80,70,200,0.12); }

  /* centered add button area (per tab) */
  .add-area {
    display:flex; justify-content:center; margin-top:10px;
  }
  .add-area button {
    padding:12px 18px; border-radius:12px; border:none; cursor:pointer;
    background: linear-gradient(90deg,var(--accent-2),var(--accent-1));
    color:#041029; font-weight:700;
  }

  /* embed cards list */
  .embeds { margin-top:14px; display:flex; gap:12px; flex-direction:column; align-items:center; }
  .embed-card { width:100%; max-width:820px; border-radius:12px; padding:12px; background:rgba(0,0,0,0.35); border:1px solid rgba(180,180,255,0.05); }
  .embed-card iframe { border-radius:10px; width:100%; height:320px; border:none; }
  .embed-card .row { display:flex; gap:8px; margin-top:10px; align-items:center; }
  .embed-card input { flex:1; padding:8px; border-radius:8px; background:rgba(0,0,0,0.45); border:1px solid rgba(200,200,255,0.06); color:white; }

  /* bottom settings */
  #settings {
    position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
    width:calc(100% - 40px); max-width:1150px; z-index:50;
    display:flex; justify-content:space-between; gap:12px; align-items:center;
    padding:10px 12px; border-radius:14px; background: rgba(10,12,24,0.46);
    border:1px solid rgba(180,180,255,0.06); backdrop-filter: blur(10px);
    box-shadow: 0 8px 30px rgba(8,10,24,0.7);
    flex-wrap:wrap;
  }
  .setting-col { display:flex; gap:10px; align-items:center; }
  .setting-col select, .setting-col input[type=range]{
    padding:8px; border-radius:10px; background:rgba(0,0,0,0.4); border:1px solid rgba(160,160,255,0.06); color:white;
  }
  .setting-col label { font-size:13px; color:#d9e6ff; margin-right:6px; }

  /* small responsive */
  @media (max-width:720px){
    .search-row input { width:58%; min-width:150px; }
    .hero h1 { font-size:36px; }
  }

  /* small subtle animations */
  .tiny-fade { transition:opacity .22s ease, transform .22s ease; }
</style>
</head>
<body>

  <!-- canvas layers (starfield, galaxy, cursor-trail) -->
  <canvas id="star-canvas" class="layer" aria-hidden="true"></canvas>
  <canvas id="galaxy-canvas" class="layer" aria-hidden="true"></canvas>
  <canvas id="cursor-canvas" class="layer" aria-hidden="true" style="z-index:10000;"></canvas>

  <!-- fog/nebula layer -->
  <div class="fog-layer" id="fog"></div>

  <!-- planet DOMs (positioned absolutely) -->
  <div class="planet-wrap" id="planetWrap" aria-hidden="true"></div>

  <!-- UI -->
  <div class="ui" id="uiRoot">
    <div class="tabs" role="tablist" id="tabList">
      <div class="tab active" role="tab" data-target="home">Home</div>
      <div class="tab" role="tab" data-target="games">Games</div>
      <div class="tab" role="tab" data-target="movies">Movies</div>
      <div class="tab" role="tab" data-target="tv">TV</div>
    </div>

    <!-- Sections -->
    <div id="home" class="section active">
      <div class="panel hero">
        <h1>Zypher</h1>
        <p class="sub">A personal cosmic portal â€” save and embed your cards, search the web, and customize your sky.</p>
        <div class="search-row">
          <input id="homeSearch" placeholder="Search the universe (Google)..." />
          <button id="homeSearchBtn">Search</button>
        </div>

        <div class="quick-links">
          <div class="quick-card" data-target="games">ðŸŽ® Games</div>
          <div class="quick-card" data-target="movies">ðŸŽ¬ Movies</div>
          <div class="quick-card" data-target="tv">ðŸ“º TV</div>
        </div>
      </div>

      <div class="panel tiny-fade">
        <div class="title">Welcome to Zypher</div>
        <p style="margin:8px 0 0 0; color:#dfe9ff;">
          This is your hub â€” add legal embed links (YouTube/Vimeo/public domain content) to cards in Games / Movies / TV. Everything you configure in the bottom settings updates live and will persist between visits.
        </p>
      </div>
    </div>

    <!-- Generic section template -->
    <div id="games" class="section">
      <div class="panel">
        <div class="title">Games</div>
        <div class="add-area"><button id="addGamesBtn">âž• Add</button></div>
        <div class="embeds" id="gamesEmbeds"></div>
      </div>
    </div>

    <div id="movies" class="section">
      <div class="panel">
        <div class="title">Movies</div>
        <div class="add-area"><button id="addMoviesBtn">âž• Add</button></div>
        <div class="embeds" id="moviesEmbeds"></div>
      </div>
    </div>

    <div id="tv" class="section">
      <div class="panel">
        <div class="title">TV</div>
        <div class="add-area"><button id="addTVBtn">âž• Add</button></div>
        <div class="embeds" id="tvEmbeds"></div>
      </div>
    </div>
  </div>

  <!-- Settings bottom bar -->
  <div id="settings" aria-hidden="false">
    <div class="setting-col">
      <label for="schemeSelect">Color:</label>
      <select id="schemeSelect" title="Color scheme">
        <option value="purple">Purple / Blue</option>
        <option value="green">Teal / Green</option>
        <option value="pink">Pink / Magenta</option>
        <option value="red">Red / Orange</option>
      </select>
    </div>

    <div class="setting-col">
      <label for="planetSpeed">Planet speed</label>
      <select id="planetSpeed">
        <option value="0.3">Slow</option>
        <option value="0.8" selected>Medium</option>
        <option value="2">Fast</option>
      </select>
    </div>

    <div class="setting-col">
      <label><input id="toggleMoons" type="checkbox" checked /> Moons</label>
    </div>

    <div class="setting-col">
      <label><input id="toggleParticles" type="checkbox" checked /> Stars</label>
    </div>

    <div class="setting-col">
      <label><input id="toggleCursor" type="checkbox" checked /> Cursor trail</label>
    </div>

    <div class="setting-col">
      <label><input id="toggleAudio" type="checkbox" /> Lofi music</label>
    </div>

    <div class="setting-col">
      <button id="resetBtn" title="Reset layout & settings">Reset</button>
    </div>
  </div>

<!-- ============================
     JAVASCRIPT
     ============================ -->
<script>
/* ============================
   Helper utils
   ============================ */
const q = s => document.querySelector(s);
const qA = s => Array.from(document.querySelectorAll(s));
const rand = (min, max) => Math.random() * (max - min) + min;

/* ============================
   Persistent state and defaults
   ============================ */
const STATE_KEY = "zypher_portal_state_v1";
const DEFAULTS = {
  scheme: "purple",
  planetSpeedMult: 0.8,
  moonsOn: true,
  particlesOn: true,
  cursorOn: true,
  audioOn: false,
  embeds: { games: [], movies: [], tv: [] }
};
let state = Object.assign({}, DEFAULTS);

/* load saved state if present */
try {
  const saved = JSON.parse(localStorage.getItem(STATE_KEY));
  if (saved) state = Object.assign({}, DEFAULTS, saved);
} catch (e) {
  console.warn("Could not parse saved state:", e);
}

/* Persist state helper */
function saveState() {
  try {
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
  } catch (e) {
    console.warn("Failed to save state:", e);
  }
}

/* ============================
   DOM wiring: tabs, quick links
   ============================ */
qA(".tab").forEach(tab => {
  tab.addEventListener("click", ev => {
    qA(".tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    const target = tab.dataset.target;
    qA(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(target).classList.add("active");
    document.title = `Zypher | ${target[0].toUpperCase() + target.slice(1)}`;
    // unload all iframe srcs to free resources
    qA(".embed-card iframe").forEach(f => { f.src = ""; });
  });
});

/* quick links to tabs */
qA(".quick-card").forEach(card => {
  card.addEventListener("click", () => {
    const t = card.dataset.target;
    qA(".tab").find(x => x.dataset.target === t)?.click();
  });
});

/* ============================
   Embed card creation + autosave
   ============================ */
function createEmbedCard(tab, url = "") {
  const container = document.getElementById(`${tab}Embeds`);
  const card = document.createElement("div");
  card.className = "embed-card";
  card.innerHTML = `
    <div style="display:flex;gap:8px; align-items:center;">
      <strong style="flex:0 0 auto">${tab.toUpperCase()}</strong>
      <div style="flex:1"></div>
      <button class="removeBtn" style="background:transparent;color:#ffb3b3;border:none;cursor:pointer;">Remove</button>
    </div>
    <iframe src="${url ? url : ''}" loading="lazy"></iframe>
    <div class="row">
      <input type="text" placeholder="Paste an embedable link (youtube/vimeo/allowed source)" value="${url ? url : ''}" />
      <button class="saveBtn">Save</button>
    </div>
  `;
  container.appendChild(card);

  const input = card.querySelector("input");
  const iframe = card.querySelector("iframe");
  const saveBtn = card.querySelector(".saveBtn");
  const removeBtn = card.querySelector(".removeBtn");

  input.addEventListener("input", () => {
    iframe.src = input.value;
  });

  saveBtn.addEventListener("click", () => {
    // save to state
    const val = input.value.trim();
    state.embeds[tab].push(val);
    saveState();
    saveBtn.textContent = "Saved";
    setTimeout(()=> saveBtn.textContent = "Save", 1100);
  });

  removeBtn.addEventListener("click", () => {
    // remove from DOM and state if matched
    const idx = state.embeds[tab].indexOf(input.value.trim());
    if (idx >= 0) state.embeds[tab].splice(idx, 1);
    card.remove();
    saveState();
  });
}

/* populate existing saved embeds on load */
function loadEmbedsFromState(){
  ["games","movies","tv"].forEach(tab => {
    const list = state.embeds[tab] || [];
    const container = document.getElementById(`${tab}Embeds`);
    container.innerHTML = ""; // clear
    list.forEach(url => createEmbedCard(tab, url));
    // ensure add button presence
  });
}

/* add button handlers (centered) */
q("#addGamesBtn").addEventListener("click", ()=> createEmbedCard("games"));
q("#addMoviesBtn").addEventListener("click", ()=> createEmbedCard("movies"));
q("#addTVBtn").addEventListener("click", ()=> createEmbedCard("tv"));

/* on load, reconstruct saved embed cards */
loadEmbedsFromState();

/* ============================
   Settings panel wiring
   ============================ */
const schemeSelect = q("#schemeSelect");
const planetSpeedSelect = q("#planetSpeed");
const toggleMoons = q("#toggleMoons");
const toggleParticles = q("#toggleParticles");
const toggleCursor = q("#toggleCursor");
const toggleAudio = q("#toggleAudio");
const resetBtn = q("#resetBtn");

// initialize UI values from state
schemeSelect.value = state.scheme || DEFAULTS.scheme;
planetSpeedSelect.value = state.planetSpeedMult || DEFAULTS.planetSpeedMult;
toggleMoons.checked = !!state.moonsOn;
toggleParticles.checked = !!state.particlesOn;
toggleCursor.checked = !!state.cursorOn;
toggleAudio.checked = !!state.audioOn;

// apply color scheme
function applyColorScheme(scheme) {
  state.scheme = scheme;
  saveState();
  if (scheme === "purple") {
    document.documentElement.style.setProperty('--accent-1', '#9fb3ff');
    document.documentElement.style.setProperty('--accent-2', '#6a4bff');
    document.documentElement.style.setProperty('--bg-1', '#080610');
    document.documentElement.style.setProperty('--bg-2', '#120925');
    q("#fog").style.background = 'radial-gradient(circle at 15% 20%, rgba(110,80,255,0.10), transparent 12%), radial-gradient(circle at 80% 70%, rgba(90,140,255,0.06), transparent 20%)';
  } else if (scheme === "green") {
    document.documentElement.style.setProperty('--accent-1', '#b3ffd6');
    document.documentElement.style.setProperty('--accent-2', '#2fe2a8');
    document.documentElement.style.setProperty('--bg-1', '#02100b');
    document.documentElement.style.setProperty('--bg-2', '#002219');
    q("#fog").style.background = 'radial-gradient(circle at 15% 20%, rgba(50,200,140,0.08), transparent 12%), radial-gradient(circle at 80% 70%, rgba(40,200,140,0.05), transparent 20%)';
  } else if (scheme === "pink") {
    document.documentElement.style.setProperty('--accent-1', '#ffd3ff');
    document.documentElement.style.setProperty('--accent-2', '#ff7bd6');
    document.documentElement.style.setProperty('--bg-1', '#110012');
    document.documentElement.style.setProperty('--bg-2', '#2a001a');
    q("#fog").style.background = 'radial-gradient(circle at 15% 20%, rgba(255,120,200,0.10), transparent 12%), radial-gradient(circle at 80% 70%, rgba(160,80,200,0.05), transparent 20%)';
  } else if (scheme === "red") {
    document.documentElement.style.setProperty('--accent-1', '#ffcbb3');
    document.documentElement.style.setProperty('--accent-2', '#ff6a4c');
    document.documentElement.style.setProperty('--bg-1', '#120305');
    document.documentElement.style.setProperty('--bg-2', '#28040b');
    q("#fog").style.background = 'radial-gradient(circle at 15% 20%, rgba(255,120,90,0.10), transparent 12%), radial-gradient(circle at 80% 70%, rgba(255,80,60,0.05), transparent 20%)';
  }
}
schemeSelect.addEventListener("change", (e)=> { applyColorScheme(e.target.value); });
applyColorScheme(schemeSelect.value); // initial

// planet speed
planetSpeedSelect.addEventListener("change",(e)=> {
  state.planetSpeedMult = parseFloat(e.target.value);
  saveState();
});

// moons on/off
toggleMoons.addEventListener("change", (e) => {
  state.moonsOn = e.target.checked;
  saveState();
  updateMoonsVisibility();
});

// particles on/off
toggleParticles.addEventListener("change", (e) => {
  state.particlesOn = e.target.checked;
  saveState();
  toggleStarRendering(state.particlesOn);
});

// cursor on/off
toggleCursor.addEventListener("change", (e) => {
  state.cursorOn = e.target.checked;
  saveState();
  q("#cursor-canvas").style.display = state.cursorOn ? "block" : "none";
});

// audio
toggleAudio.addEventListener("change", (e) => {
  state.audioOn = e.target.checked;
  saveState();
  setAudioState(state.audioOn);
});

resetBtn.addEventListener("click", () => {
  if (!confirm("Reset settings and saved embeds to defaults?")) return;
  state = Object.assign({}, DEFAULTS);
  saveState();
  location.reload();
});

/* ============================
   Audio (chill lofi) â€” user toggle only
   ============================ */
const LOFI_SRC = "https://assets.mixkit.co/music/preview/mixkit-lofi-chill-beats-1787.mp3"; // royalty-free-ish preview
const audio = new Audio(LOFI_SRC);
audio.loop = true;
audio.volume = 0.28;

function setAudioState(on) {
  try {
    if (on) audio.play(); else audio.pause();
  } catch (e) { console.warn("audio play error", e); }
}
if (state.audioOn) setAudioState(true);

/* ============================
   Starfield & galaxy rendering (multi-layered)
   ============================ */
/* We'll render two layers: stars (fast twinkle) and galaxies (soft rotated shapes) */
const starCanvas = q("#star-canvas");
const galaxyCanvas = q("#galaxy-canvas");
const cursorCanvas = q("#cursor-canvas");
const starCtx = starCanvas.getContext("2d", { alpha:true });
const galaxyCtx = galaxyCanvas.getContext("2d", { alpha:true });
const cursorCtx = cursorCanvas.getContext("2d", { alpha:true });

function fitCanvas(c) { c.width = innerWidth; c.height = innerHeight; }
[starCanvas, galaxyCanvas, cursorCanvas].forEach(fitCanvas);
window.addEventListener("resize", ()=> { [starCanvas, galaxyCanvas, cursorCanvas].forEach(fitCanvas); initStars(); initGalaxies(); });

let stars = [];
let galaxies = [];
function initStars(){
  stars = [];
  const COUNT = Math.min(700, Math.floor(window.innerWidth * window.innerHeight / 1200)); // performance-tuned
  for (let i=0;i<COUNT;i++){
    stars.push({
      x: Math.random()*starCanvas.width,
      y: Math.random()*starCanvas.height,
      size: Math.random()*1.6 + 0.4,
      baseAlpha: Math.random()*0.9,
      phase: Math.random()*Math.PI*2,
      speed: Math.random()*0.18 + 0.02
    });
  }
}
function drawStars(time){
  starCtx.clearRect(0,0,starCanvas.width,starCanvas.height);
  if (!state.particlesOn) return;
  const t = time * 0.001;
  for (let s of stars){
    const a = s.baseAlpha * (0.6 + 0.4*Math.sin(s.phase + t*2*s.speed));
    starCtx.fillStyle = `rgba(230,240,255,${a})`;
    starCtx.fillRect(Math.round(s.x), Math.round(s.y), Math.max(1, Math.round(s.size)), Math.max(1, Math.round(s.size)));
    // drift slightly
    s.y += s.speed * 0.35;
    if (s.y > starCanvas.height + 8) { s.y = -8; s.x = Math.random()*starCanvas.width; }
  }
}

/* GALAXY soft rings (drawn asthetically) */
function initGalaxies(){
  galaxies = [];
  const GCOUNT = 3 + Math.floor(Math.random()*3);
  for (let i=0;i<GCOUNT;i++){
    galaxies.push({
      x: rand(0.15,0.85)*galaxyCanvas.width,
      y: rand(0.12,0.86)*galaxyCanvas.height,
      r: rand(60, 180),
      hue: rand(200, 290),
      rot: rand(0, Math.PI*2),
      speed: rand(0.0003, 0.001)
    });
  }
}
function drawGalaxies(time){
  galaxyCtx.clearRect(0,0,galaxyCanvas.width,galaxyCanvas.height);
  for (let g of galaxies){
    g.rot += g.speed * (time*0.001);
    // soft outer swirl
    galaxyCtx.save();
    galaxyCtx.translate(g.x, g.y);
    galaxyCtx.rotate(g.rot);
    const grad = galaxyCtx.createRadialGradient(0,0,0, 0,0,g.r);
    // sample two accent colors based on hue
    const h1 = Math.floor(g.hue), h2 = Math.floor((g.hue+40)%360);
    grad.addColorStop(0, `hsla(${h1},60%,85%,0.14)`);
    grad.addColorStop(0.3, `hsla(${h2},60%,70%,0.08)`);
    grad.addColorStop(1, `rgba(255,255,255,0)`);
    galaxyCtx.fillStyle = grad;
    galaxyCtx.beginPath(); galaxyCtx.arc(0,0,g.r,0,Math.PI*2); galaxyCtx.fill();
    galaxyCtx.restore();
  }
}

/* animate star & galaxy layers */
let lastTime = 0;
function renderLoop(ts){
  if (!lastTime) lastTime = ts;
  const dt = ts - lastTime;
  drawStars(ts);
  drawGalaxies(ts);
  // cursor particles drawn elsewhere
  lastTime = ts;
  requestAnimationFrame(renderLoop);
}
initStars(); initGalaxies(); requestAnimationFrame(renderLoop);

/* ============================
   Cursor trail (canvas particles)
   ============================ */
const cursorParticles = [];
cursorCanvas.style.zIndex = 10001;
cursorCanvas.style.pointerEvents = "none";

function addCursorParticle(x,y){
  cursorParticles.push({
    x, y, vx: (Math.random()-0.5)*0.8, vy: (Math.random()-0.3)*0.8,
    life: 800 + Math.random()*600, age:0, size: 6 + Math.random()*6
  });
}

function updateCursorParticles(dt){
  cursorCtx.clearRect(0,0,cursorCanvas.width,cursorCanvas.height);
  if (!state.cursorOn) return;
  for (let i = cursorParticles.length-1; i >= 0; i--){
    const p = cursorParticles[i];
    p.age += dt;
    if (p.age > p.life) { cursorParticles.splice(i,1); continue; }
    p.x += p.vx;
    p.y += p.vy;
    const a = 1 - (p.age / p.life);
    cursorCtx.beginPath();
    const g = cursorCtx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.size);
    g.addColorStop(0, `rgba(200,220,255,${0.9*a})`);
    g.addColorStop(1, `rgba(80,100,150,${0.0})`);
    cursorCtx.fillStyle = g;
    cursorCtx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
  }
}

/* hook pointer */
let lastPointer = {x: innerWidth/2, y: innerHeight/2, t: performance.now()};
window.addEventListener("pointermove", (ev) => {
  if (state.cursorOn) addCursorParticle(ev.clientX, ev.clientY);
  // parallax effect
  pointerX = ev.clientX; pointerY = ev.clientY;
});

/* schedule particle update */
let prevFrame = performance.now();
function cursorLoop(ts){
  const dt = Math.max(0, ts - prevFrame);
  updateCursorParticles(dt);
  prevFrame = ts;
  requestAnimationFrame(cursorLoop);
}
requestAnimationFrame(cursorLoop);

/* ============================
   Planet system: multiple planets, rings, moons, orbit mechanics
   ============================ */
const planetWrap = q("#planetWrap");
const PLANET_COUNT = 6;
const planets = []; // will hold planet objects

function createPlanet(index){
  // compute nice layout across screen with randomness
  const size = 60 + index * 18 + Math.round(Math.random()*36);
  const left = 6 + index * (100 / PLANET_COUNT) + Math.random()*6;
  const top = 12 + (index % 2 === 0 ? 8 : 36) + Math.random()*18;
  const el = document.createElement("div");
  el.className = "planet";
  el.style.width = `${size}px`;
  el.style.height = `${size}px`;
  el.style.left = `${left}vw`;
  el.style.top = `${top}vh`;

  // create ring
  const ring = document.createElement("div");
  ring.className = "ring";
  const ringSize = size * 2.2;
  ring.style.width = `${ringSize}px`;
  ring.style.height = `${Math.max(8, ringSize / 3)}px`;
  ring.style.border = `3px solid rgba(200,200,255,0.08)`;
  ring.style.left = `calc(50% - ${ringSize/2}px)`;
  ring.style.top = `calc(50% - ${Math.max(4, ringSize / 6)}px)`;
  el.appendChild(ring);

  // planet surface style (color will be updated by scheme)
  el.style.background = `radial-gradient(circle at 30% 30%, rgba(255,255,255,0.08), rgba(60,40,120,0.9))`;
  el.style.border = `1px solid rgba(255,255,255,0.03)`;

  planetWrap.appendChild(el);

  // moons container
  const moons = [];
  const moonCount = 1 + Math.floor(Math.random()*3); // 1..3 moons per planet
  for (let m = 0; m < moonCount; m++){
    const moon = document.createElement("div");
    moon.className = "moon";
    const mw = Math.round(size * (0.14 + Math.random()*0.22));
    moon.style.width = `${mw}px`;
    moon.style.height = `${mw}px`;
    moon.style.left = `${left}vw`;
    moon.style.top = `${top}vh`;
    moon.style.opacity = 0.0;
    planetWrap.appendChild(moon);
    moons.push({
      el: moon,
      orbitRadius: (size/2) + 20 + Math.random()*40,
      angle: Math.random()*Math.PI*2,
      speed: (0.003 + Math.random()*0.007) * (Math.random() > 0.5 ? 1 : -1)
    });
  }

  const planetObj = {
    el,
    ring,
    size,
    baseLeftVW: left, baseTopVH: top,
    rotation: Math.random()*Math.PI*2,
    rotSpeed: (0.0005 + Math.random()*0.002) * (Math.random() > 0.5 ? 1 : -1),
    moons
  };
  planets.push(planetObj);
}

function createPlanets(){
  planetWrap.innerHTML = "";
  planets.length = 0;
  for (let i=0;i<PLANET_COUNT;i++) createPlanet(i);
}
createPlanets();

/* planet animation loop */
let pLast = performance.now();
function animatePlanets(now){
  const dt = (now - pLast);
  pLast = now;
  const speedMult = parseFloat(state.planetSpeedMult || 0.8);

  for (let p of planets){
    // rotate on axis
    p.rotation += p.rotSpeed * speedMult * dt;
    p.el.style.transform = `rotate(${p.rotation}rad)`;

    // ring rotate slowly
    p.ring.style.transform = `rotate(${p.rotation*0.6}deg)`;

    // moons orbit
    for (let m of p.moons){
      if (!state.moonsOn){
        m.el.style.opacity = 0; continue;
      }
      m.el.style.opacity = 1.0;
      m.angle += m.speed * speedMult * dt;
      // compute planet center in px
      const rect = p.el.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const ox = cx + Math.cos(m.angle) * m.orbitRadius;
      const oy = cy + Math.sin(m.angle) * m.orbitRadius * 0.6; // slight ellipse
      m.el.style.left = `${ox - (parseFloat(m.el.style.width) / 2)}px`;
      m.el.style.top = `${oy - (parseFloat(m.el.style.height) / 2)}px`;
    }
  }

  requestAnimationFrame(animatePlanets);
}
requestAnimationFrame(animatePlanets);

/* ============================
   Parallax: move fog & galaxies slightly based on mouse
   ============================ */
let pointerX = innerWidth/2, pointerY = innerHeight/2;
window.addEventListener("mousemove", e => { pointerX = e.clientX; pointerY = e.clientY; });

function parallaxLoop(){
  const cx = innerWidth/2, cy = innerHeight/2;
  const dx = (pointerX - cx) / cx; // -1..1
  const dy = (pointerY - cy) / cy;
  // fog translate
  const fog = q("#fog");
  fog.style.transform = `translate(${dx*6}%, ${dy*6}%)`;
  // galaxies rotate slightly (done in drawGalaxies)
  // planets: shift by small amount
  for (let i=0;i<planets.length;i++){
    const p = planets[i];
    const factor = 6 + i*0.5;
    const l = p.baseLeftVW || parseFloat(p.el.style.left);
    const t = p.baseTopVH || parseFloat(p.el.style.top);
    const px = (l/100) * innerWidth + dx * factor;
    const py = (t/100) * innerHeight + dy * (factor*0.6);
    // we won't reposition base left/top here (to keep responsive), only translate
    p.el.style.transform += ` translate(${dx * (factor*0.15)}px, ${dy * (factor*0.15)}px)`;
  }

  requestAnimationFrame(parallaxLoop);
}
requestAnimationFrame(parallaxLoop);

/* ============================
   Toggle star rendering
   ============================ */
function toggleStarRendering(on){
  state.particlesOn = !!on;
  saveState();
  if (!on) starCtx.clearRect(0,0,starCanvas.width, starCanvas.height);
}
toggleStarRendering(state.particlesOn);

/* ============================
   Update moons visibility helper
   ============================ */
function updateMoonsVisibility() {
  for (let p of planets) {
    for (let m of p.moons) {
      m.el.style.display = state.moonsOn ? "block" : "none";
    }
  }
}
updateMoonsVisibility();

/* ============================
   Load saved embed cards into UI
   ============================ */
loadEmbedsFromState(); // already called earlier to build any saved cards

/* ============================
   Home search handler
   ============================ */
q("#homeSearchBtn").addEventListener("click", () => {
  const qv = q("#homeSearch").value.trim();
  if (!qv) return;
  window.open("https://www.google.com/search?q=" + encodeURIComponent(qv), "_blank");
});

/* keyboard: Ctrl+K focuses search */
window.addEventListener("keydown", (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
    e.preventDefault();
    q("#homeSearch").focus();
  }
});

/* ============================
   Save settings on change loop (debounced)
   ============================ */
let saveTimeout = null;
qA("#settings select, #settings input").forEach(el => {
  el.addEventListener("change", () => {
    // update state from DOM values
    state.scheme = schemeSelect.value;
    state.planetSpeedMult = parseFloat(planetSpeedSelect.value);
    state.moonsOn = toggleMoons.checked;
    state.particlesOn = toggleParticles.checked;
    state.cursorOn = toggleCursor.checked;
    state.audioOn = toggleAudio.checked;
    // apply color scheme quickly
    applyColorScheme(state.scheme);
    // update moons visibility
    updateMoonsVisibility();
    // show/hide cursor
    q("#cursor-canvas").style.display = state.cursorOn ? "block" : "none";
    // start/stop audio
    setAudioState(state.audioOn);
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveState, 400);
  });
});

/* ============================
   Initial UI: create saved embed cards if any (already done)
   and ensure add buttons centered visually
   ============================ */
qA(".add-area").forEach(a => {
  a.style.textAlign = "center";
  // ensure the button is centered
  const btn = a.querySelector("button");
  if (btn) { btn.style.minWidth = "140px"; btn.style.fontWeight = 700; }
});

/* ============================
   Accessibility & cleanup: When switching tabs, unload iframes
   (already done in tab handler) â€” also handle beforeunload
   ============================ */
window.addEventListener("beforeunload", () => {
  try { saveState(); } catch(_) {}
});

/* ============================
   Final: expose a small debugging helper
   ============================ */
window.ZypherPortal = {
  state,
  saveState,
  createEmbedCard
};

console.info("Zypher portal initialized. State:", state);
</script>
</body>
</html>
